# 240404

러스트 정리 (10)

## 1. 라이프타임
참조자가 유효함을 보장하는 기간

라이프타임도 암묵적 추론이 가능하지만 여러 타입이 될 가능성이 있는 경우엔 타입을 명시해야함.

- 라이프타임 매개변수를 지정해도 전달되는 값이나 반환 값의 라이프타임이 변경되는 건 아님
- 제약조건을 지키지 않았을때 대여 검사기가 불합격 판정을 내릴수 있도록 하는것.
  - 대여 검사기(borrow checker)로 스코프를 비교해서 대여의 유효성을 판단함.

```rust
&i32        // 참조자
&'a i32     // 명시적인 라이프타임이 있는 참조자
&'a mut i32 // 명시적인 라이프타임이 있는 가변 참조자
```
- `'a`와 같이 `'(Apostrophe) + 짧은 소문자`로 명시함.

라이프타임은 댕글링 참조(dangling reference) 방지가 목적임
- 프로그램이 참조하려고 하는 데이터가 아닌 엉뚱한 데이터를 참조하는 것

라이프타임 생략 규칙(lifetime elision rules)이 있음
- 라이프타임이 생략되어있어도 컴파일러가 추론할수 있도록 함.
- 추론이 완전하지않으므로 에러가 뜰 수 있음. 에러가 뜨는 경우 명시해서 작성하면됨.
  1. 컴파일러가 참조자인 모든 매개변수에 라이프타임을 할당한다
  2. 만약 입력 라이프타임 매개변수가 하나라면, 해당 라이프타임을 출력 라이프타임에 대입한다
  3. 입력 라이프타임 매개변수가 여러 개이고, 그 중 하나가 &self나 &mut self라면, self의 라이프타임을 모든 출력 라이프타임 매개변수에 대입한다.
    - 메서드인 경우에 적용

정적 라이프타임('static)

- 프로그램의 전체 생애주기동안 살아있는 참조자.

ex) 모든 문자열 리터럴
정적 라이프타임을 사용하기전에 실제로 유지되어야만 하는 참조자인지 고민해봐야함. 

## 2 테스트

### 2.1. 테스트
코드가 의도대로 수행되는지 검증하는 것.

테스트 함수에 필요한 것

1. 데이터 및 상태 설정
2. 테스트 코드 실행
3. 결과 비교

함수의 fn 이전 줄에 `#[test]` 를 추가하면 테스트함수로 사용할 수 있음.

- cargo test 명령어로 실행할 수 있음. 
- 특정 인스턴스에서는 실행되지 않도록 할 수 있음.
- cargo test에 인수를 넘겨서 이름이 일치하는 테스트만 실행 하도록 할수 있음(필터링)
- Doc-tests ~~ : API 문서에 작성해 놓은 예제코드도 테스트 할 수 있음

결과 검사

1. assert! 
   - true 인 경우 pass
   - false 인 경우 panic! 발생
2. assert_eq!
3. assert_ne! 
4. should_panic: 에러조건 처리하는지 확인
    - 내부에서 패닉이 발생해야 통과됨
    - 함수이름 위에  #[should_panic] 추가
5. Result<T, E>
    - should_panic 어노테이션 사용 불가능



### 2.2. 테스트 실행방법 제어
cargo test로 생성된 바이너리는 모든 테스트를 병렬로 실행하고 테스트가 수행되는 동안 발생된 출력을 캡처한다.
- 명령어 옵션을 통해서 바꿀수 있음
- cargo test <args_for_cargo_test> -- <args_for_test_binary>


`cargo test -- --test-threads=1`
- 기본 테스트는 병렬 수행임. 공유 상태를 가지면 안됨.
- 사용할 스레드를 1로 조절하면 병렬로 처리하지 않으므로 순차적으로 테스트를 진행함.

`cargo test -- --show-output`
- 기본 테스트는 발생된 출력을 보여주지 않음.
- 해당 옵션을 사용해서 출력을 보여줄수 있음

`cargo test (<func_name> or <filter_word>)`
- 특정 함수 하나만 테스트 실행할수 있음.
- 공통적으로 포함된 단어로 테스트 함수를 필터링할 수 있음

`cargo test -- --ignored`
- 제외된 테스트만 실행할수 있음
- `cargo test -- --include-ignored` 로 모든 테스트를 진행할수있음
- #[ignore] 를 함수에 붙여서 기본 테스트에서 제외시킬수 있음


### 2.3. 테스트 조직화
유닛테스트(단위테스트): 한 모듈만 테스트
- 테스트 코드가 실제 코드와 같이 있음
- #[cfg(test)]를 사용해서 컴파일 소요시간을 줄일수 있음(줄여야 함)

러스트에선 비공개 함수도 테스트할 수 있음
- 다른 언어에서는 비공개 함수를 테스트하기 어렵거나 불가능함.


통합테스트: 모든 기능 테스트
- 테스트 코드가 분리되어있음. tests 디렉토리 필요함. #[cfg(test)] 가 필요없음
- 공개 API만 호출 가능.

---

https://doc.rust-kr.org/ch10-03-lifetime-syntax.html
https://doc.rust-kr.org/ch11-00-testing.html